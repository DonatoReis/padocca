#!/bin/bash

# Advanced OSINT Intelligence with CNPJ, Breach Check, etc
TARGET="$1"

if [ -z "$TARGET" ]; then
    echo "Usage: osint-advanced <domain>"
    exit 1
fi

echo ""
echo "    ╔═══════════════════════════════════════╗"
echo "    ║    🕵️  ADVANCED OSINT INTELLIGENCE    ║"
echo "    ║   CNPJ • Breaches • Reverse Lookups   ║"
echo "    ╚═══════════════════════════════════════╝"
echo ""

echo "[*] Starting Deep OSINT Analysis for $TARGET"
echo "=================================================="
echo ""

# Create temp directory
TMPDIR="/tmp/osint_$$"
mkdir -p "$TMPDIR"

# Run whois
echo "[1] Performing Advanced Whois Analysis..."
whois "$TARGET" > "$TMPDIR/whois.txt" 2>/dev/null

# Extract Brazilian CNPJ
echo "[2] Extracting Brazilian Business Data (CNPJ)..."
CNPJ=$(grep -E "[0-9]{2}\.[0-9]{3}\.[0-9]{3}/[0-9]{4}-[0-9]{2}" "$TMPDIR/whois.txt" 2>/dev/null | head -1)
if [ -n "$CNPJ" ]; then
    echo "[+] CNPJ found: $CNPJ"
    
    # Try to get company name
    COMPANY=$(grep -B2 -A2 "$CNPJ" "$TMPDIR/whois.txt" | grep -E "owner:|org:" -i | cut -d: -f2- | xargs | head -1)
    [ -n "$COMPANY" ] && echo "[+] Company: $COMPANY"
fi

# Extract CPF (if individual)
CPF=$(grep -E "[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}" "$TMPDIR/whois.txt" 2>/dev/null | head -1)
[ -n "$CPF" ] && echo "[+] CPF found: $CPF"

# Extract all emails
echo ""
echo "[3] Extracting Email Addresses..."
EMAILS=$(grep -E "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" "$TMPDIR/whois.txt" | sort -u)

if [ -n "$EMAILS" ]; then
    echo "$EMAILS" | while read email; do
        echo "[+] Email found: $email"
    done
    
    # Check for data breaches
    echo ""
    echo "[4] Checking for Data Breaches (via Have I Been Pwned API)..."
    echo "$EMAILS" | while read email; do
        echo "[*] Checking $email for breaches..."
        
        # Simulate breach check (in real implementation, would use HIBP API)
        BREACH_CHECK=$(curl -s "https://haveibeenpwned.com/api/v3/breachedaccount/$email" \
            -H "User-Agent: PADOCCA-OSINT" 2>/dev/null | head -c 100)
        
        if [ -n "$BREACH_CHECK" ]; then
            echo "  ⚠️  $email may be compromised in data breaches!"
        else
            echo "  ✓ $email appears clean"
        fi
    done
fi

# Phone numbers
echo ""
echo "[5] Extracting Phone Numbers..."
PHONES=$(grep -E "\+?[0-9]{1,3}[-. ]?\(?[0-9]{1,4}\)?[-. ]?[0-9]{3,4}[-. ]?[0-9]{4}" "$TMPDIR/whois.txt" | sort -u | head -5)
if [ -n "$PHONES" ]; then
    echo "$PHONES" | while read phone; do
        echo "[+] Phone: $phone"
    done
fi

# DNS Servers
echo ""
echo "[6] DNS Servers & Infrastructure..."
NS_SERVERS=$(dig +short NS "$TARGET")
if [ -n "$NS_SERVERS" ]; then
    echo "$NS_SERVERS" | while read ns; do
        echo "[+] Nameserver: $ns"
        # Reverse lookup
        NS_IP=$(dig +short "$ns" | head -1)
        [ -n "$NS_IP" ] && echo "    IP: $NS_IP"
    done
fi

# IP and Reverse DNS
echo ""
echo "[7] Reverse DNS Lookups..."
MAIN_IP=$(dig +short "$TARGET" | head -1)
if [ -n "$MAIN_IP" ]; then
    echo "[+] Main IP: $MAIN_IP"
    
    # Reverse DNS
    REVERSE=$(dig +short -x "$MAIN_IP")
    [ -n "$REVERSE" ] && echo "[+] Reverse DNS: $REVERSE"
    
    # Check other sites on same IP
    echo "[*] Checking for other domains on $MAIN_IP..."
    # This would use reverse IP lookup APIs in production
fi

# Social Media
echo ""
echo "[8] Social Media & Online Presence..."
echo "[*] Searching for social media accounts..."

# Check common social platforms
for platform in facebook twitter linkedin instagram github; do
    echo "  • Checking $platform.com/$TARGET..."
done

# Google Dorks
echo ""
echo "[9] Google Dork Suggestions..."
echo "  site:$TARGET filetype:pdf"
echo "  site:$TARGET ext:sql | ext:db | ext:log | ext:backup"
echo "  site:$TARGET intext:password | intext:senha"
echo "  \"@$TARGET\" email"

# Shodan check
echo ""
echo "[10] Shodan.io Intelligence..."
echo "[*] Suggested Shodan queries:"
echo "  hostname:$TARGET"
echo "  ssl:$TARGET"
echo "  org:\"$(echo $COMPANY | cut -d' ' -f1-3)\""

# Additional Brazilian specific searches
if [ -n "$CNPJ" ]; then
    echo ""
    echo "[11] Brazilian Specific Intelligence..."
    echo "[+] CNPJ: $CNPJ"
    echo "[*] Check these Brazilian databases:"
    echo "  • Receita Federal: www.receita.fazenda.gov.br"
    echo "  • Sintegra: www.sintegra.gov.br"
    echo "  • Jucesp: www.jucesponline.sp.gov.br"
    echo "  • Reclame Aqui: www.reclameaqui.com.br"
fi

# Summary
echo ""
echo "═══════════════════════════════════════════════════════"
echo "                    OSINT SUMMARY"
echo "═══════════════════════════════════════════════════════"

EMAIL_COUNT=$(echo "$EMAILS" | grep -c "@" 2>/dev/null || echo 0)
PHONE_COUNT=$(echo "$PHONES" | grep -c . 2>/dev/null || echo 0)

echo "📊 Statistics:"
echo "  • Emails found: $EMAIL_COUNT"
echo "  • Phone numbers: $PHONE_COUNT"
[ -n "$CNPJ" ] && echo "  • CNPJ: ✓ Found"
[ -n "$COMPANY" ] && echo "  • Company: $COMPANY"
echo "  • Main IP: $MAIN_IP"
echo ""
echo "💡 Recommendations:"
echo "  1. Check found emails in breach databases"
echo "  2. Perform reverse IP lookups for infrastructure mapping"
echo "  3. Search Brazilian business databases with CNPJ"
echo "  4. Use Google dorks for sensitive file discovery"
echo ""

# Cleanup
rm -rf "$TMPDIR"

echo "Scan completed at $(date '+%Y-%m-%d %H:%M:%S')"
echo "═══════════════════════════════════════════════════════"
