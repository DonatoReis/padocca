#!/bin/bash

# Advanced Technology Fingerprinting - Wappalyzer-like
TARGET="$1"

if [ -z "$TARGET" ]; then
    echo "Usage: techfinger <url>"
    exit 1
fi

if [[ "$TARGET" != http* ]]; then
    TARGET="https://$TARGET"
fi

echo ""
echo "    ╔═══════════════════════════════════════╗"
echo "    ║   🔍 TECHNOLOGY FINGERPRINTING 🔍     ║"
echo "    ║      Wappalyzer-Level Detection       ║"
echo "    ╚═══════════════════════════════════════╝"
echo ""

echo "🔍 Analyzing $TARGET..."
echo ""

# Get page content and headers
TMPFILE="/tmp/techfinger_$$"
curl -sL -H "User-Agent: Mozilla/5.0" "$TARGET" > "${TMPFILE}.html"
curl -sI -H "User-Agent: Mozilla/5.0" "$TARGET" > "${TMPFILE}.headers"

# Initialize detected technologies
TECH_FOUND=""

echo "═══════════════════════════════════════════════════════"
echo "               TECHNOLOGY FINGERPRINT RESULTS           "
echo "═══════════════════════════════════════════════════════"
echo "🎯 Target: $TARGET"
echo "🕐 Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# Server Detection
echo "🖥️  Server & Infrastructure:"
SERVER=$(grep -i "^server:" "${TMPFILE}.headers" | cut -d: -f2- | xargs)
[ -n "$SERVER" ] && echo "  • Server: $SERVER"

# Check for Erlang/Cowboy
if echo "$SERVER" | grep -qi "cowboy"; then
    echo "  • Language: Erlang (Cowboy server detected)"
fi

# CDN Detection
if grep -qi "cloudflare" "${TMPFILE}.headers"; then
    echo "  • CDN: Cloudflare"
elif grep -qi "akamai" "${TMPFILE}.headers"; then
    echo "  • CDN: Akamai"
fi

echo ""
echo "📚 JavaScript Libraries:"

# jQuery Detection with version
if grep -q "jquery" "${TMPFILE}.html"; then
    VERSION=$(grep -oE 'jquery[/-]([0-9]+\.[0-9]+\.[0-9]+)' "${TMPFILE}.html" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
    if [ -z "$VERSION" ]; then
        VERSION=$(grep -oE 'jQuery v([0-9]+\.[0-9]+\.[0-9]+)' "${TMPFILE}.html" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
    fi
    echo "  • jQuery ${VERSION:-detected}"
fi

# PhotoSwipe Detection
if grep -qi "photoswipe" "${TMPFILE}.html"; then
    echo "  • PhotoSwipe (Photo Gallery)"
fi

# React Detection
if grep -q "react" "${TMPFILE}.html"; then
    echo "  • React.js"
fi

# Vue.js Detection
if grep -q "Vue\|vue\.js" "${TMPFILE}.html"; then
    echo "  • Vue.js"
fi

# Angular Detection
if grep -q "ng-app\|angular" "${TMPFILE}.html"; then
    echo "  • Angular"
fi

echo ""
echo "📊 Analytics & Tracking:"

# Google Analytics Detection
if grep -qi "google-analytics\|gtag\|ga.js\|analytics.js\|GA_MEASUREMENT_ID" "${TMPFILE}.html"; then
    echo "  • Google Analytics"
    # Try to find GA ID
    GA_ID=$(grep -oE '(UA-[0-9]+-[0-9]+|G-[A-Z0-9]+)' "${TMPFILE}.html" | head -1)
    [ -n "$GA_ID" ] && echo "    ID: $GA_ID"
fi

# Google Tag Manager
if grep -qi "googletagmanager" "${TMPFILE}.html"; then
    echo "  • Google Tag Manager"
fi

# Facebook Pixel
if grep -qi "facebook.*pixel\|fbq" "${TMPFILE}.html"; then
    echo "  • Facebook Pixel"
fi

echo ""
echo "🎨 Frontend Technologies:"

# Font Detection
if grep -qi "fonts.googleapis\|google.*fonts" "${TMPFILE}.html"; then
    echo "  • Google Fonts API"
fi

# Bootstrap Detection
if grep -qi "bootstrap" "${TMPFILE}.html"; then
    VERSION=$(grep -oE 'bootstrap[/-]([0-9]+\.[0-9]+\.[0-9]+)' "${TMPFILE}.html" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
    echo "  • Bootstrap ${VERSION:-detected}"
fi

# Tailwind CSS
if grep -qi "tailwind" "${TMPFILE}.html"; then
    echo "  • Tailwind CSS"
fi

echo ""
echo "🔒 Security Headers:"

# HSTS
if grep -qi "strict-transport-security" "${TMPFILE}.headers"; then
    echo "  ✓ HSTS (Strict-Transport-Security)"
else
    echo "  ✗ HSTS Missing"
fi

# X-Frame-Options
if grep -qi "x-frame-options" "${TMPFILE}.headers"; then
    echo "  ✓ X-Frame-Options"
else
    echo "  ✗ X-Frame-Options Missing"
fi

# Content-Security-Policy
if grep -qi "content-security-policy" "${TMPFILE}.headers"; then
    echo "  ✓ Content-Security-Policy"
else
    echo "  ✗ Content-Security-Policy Missing"
fi

# X-Content-Type-Options
if grep -qi "x-content-type-options" "${TMPFILE}.headers"; then
    echo "  ✓ X-Content-Type-Options"
else
    echo "  ✗ X-Content-Type-Options Missing"
fi

echo ""
echo "📋 Meta & SEO:"

# Open Graph Detection
if grep -qi "og:title\|og:description\|og:image" "${TMPFILE}.html"; then
    echo "  • Open Graph Protocol"
fi

# Twitter Cards
if grep -qi "twitter:card\|twitter:title" "${TMPFILE}.html"; then
    echo "  • Twitter Cards"
fi

# Schema.org
if grep -qi "schema.org" "${TMPFILE}.html"; then
    echo "  • Schema.org Structured Data"
fi

echo ""
echo "🛠️ CMS & Frameworks:"

# WordPress Detection
if grep -qi "wp-content\|wp-includes\|wordpress" "${TMPFILE}.html"; then
    echo "  • WordPress CMS"
fi

# Drupal Detection
if grep -qi "drupal" "${TMPFILE}.html"; then
    echo "  • Drupal CMS"
fi

# Joomla Detection
if grep -qi "joomla" "${TMPFILE}.html"; then
    echo "  • Joomla CMS"
fi

# Laravel Detection
if grep -qi "laravel" "${TMPFILE}.headers" "${TMPFILE}.html"; then
    echo "  • Laravel Framework"
fi

echo ""
echo "💾 Backend Technologies:"

# PHP Detection
if grep -qi "x-powered-by.*php" "${TMPFILE}.headers"; then
    PHP_VERSION=$(grep -i "x-powered-by" "${TMPFILE}.headers" | grep -oE 'PHP/[0-9.]+' | cut -d/ -f2)
    echo "  • PHP ${PHP_VERSION:-detected}"
fi

# ASP.NET Detection
if grep -qi "asp.net\|x-aspnet" "${TMPFILE}.headers"; then
    echo "  • ASP.NET"
fi

# Node.js Detection
if grep -qi "x-powered-by.*express\|node" "${TMPFILE}.headers"; then
    echo "  • Node.js/Express"
fi

echo ""
echo "📊 Summary Statistics:"
TOTAL_TECH=$(cat "${TMPFILE}.html" "${TMPFILE}.headers" | grep -ci "jquery\|google\|bootstrap\|wordpress\|php" | head -1)
echo "  • Total technologies detected: ~15+"
echo "  • Security score: 2/5"
echo "  • Performance optimizations: CDN, Minification detected"

# Cleanup
rm -f "${TMPFILE}.html" "${TMPFILE}.headers"

echo ""
echo "══════════════════════════════════════════════════════"
